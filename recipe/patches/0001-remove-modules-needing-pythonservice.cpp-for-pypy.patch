From 473a35adafc1e9a13d8a5c76bfbbb1d0c8a0cb3d Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Mon, 23 Aug 2021 07:08:14 -0500
Subject: [PATCH] remove modules needing pythonservice.cpp for pypy

---
 setup.py | 30 +++++++++++++++++++-----------
 1 file changed, 19 insertions(+), 11 deletions(-)

diff --git a/setup.py b/setup.py
index 1d0d0a8d..0485383c 100644
--- a/setup.py
+++ b/setup.py
@@ -113,6 +113,8 @@ try:
 except ValueError:
     skip_verstamp = False
 
+IS_PYPY = sys.implementation.name == 'pypy'
+
 try:
     this_file = __file__
 except NameError:
@@ -1488,13 +1490,15 @@ win32_extensions += [
            windows_h_version=0x0500,
         ),
 ]
-win32_extensions += [
-    WinExt_win32('servicemanager',
-           sources = ["win32/src/PythonServiceMessages.mc", "win32/src/PythonService.cpp"],
-           extra_compile_args = ['-DPYSERVICE_BUILD_DLL'],
-           libraries = "user32 ole32 advapi32 shell32",
-           windows_h_version = 0x500),
-]
+
+if not IS_PYPY:
+    win32_extensions += [
+        WinExt_win32('servicemanager',
+            sources = ["win32/src/PythonServiceMessages.mc", "win32/src/PythonService.cpp"],
+            extra_compile_args = ['-DPYSERVICE_BUILD_DLL'],
+            libraries = "user32 ole32 advapi32 shell32",
+            windows_h_version = 0x500),
+    ]
 
 win32_extensions += [
     WinExt_win32('win32help',
@@ -2076,10 +2080,6 @@ other_extensions.append(
 )
 
 W32_exe_files = [
-    WinExt_win32_subsys_con("pythonservice",
-         sources=[os.path.join("win32", "src", s) for s in
-                  "PythonService.cpp PythonService.rc".split()],
-         libraries = "user32 advapi32 ole32 shell32"),
     WinExt_pythonwin_subsys_win("Pythonwin",
         sources = [
             "Pythonwin/pythonwin.cpp",
@@ -2093,6 +2093,14 @@ W32_exe_files = [
         optional_headers=['afxres.h']),
 ]
 
+if not IS_PYPY:
+    W32_exe_files += [
+        WinExt_win32_subsys_con("pythonservice",
+            sources=[os.path.join("win32", "src", s) for s in
+                  "PythonService.cpp PythonService.rc".split()],
+            libraries = "user32 advapi32 ole32 shell32"),
+    ]
+
 # Special definitions for SWIG.
 swig_interface_parents = {
     # source file base,     "base class" for generated COM support
-- 
2.28.0

